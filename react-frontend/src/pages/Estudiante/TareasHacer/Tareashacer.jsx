import "./TareasHacer.css";
import NavbarModulo from "../../../components/layout/Navbar/NavbarModulo";
import { useNavigate } from "react-router-dom";
import TaskStudent from "../../../components/ui/TaskStudent";
import { useState } from "react";
import { X, Calendar, FileText, Download, UploadCloud, MessageSquare } from "lucide-react";

const Tareashacer = () => {
  const navigate = useNavigate();
  const [selectedTask, setSelectedTask] = useState(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [uploadedFiles, setUploadedFiles] = useState([]);
  const [comment, setComment] = useState("");

  const handleBack = () => {
    navigate("/estudiante");
  };

  const homework = [
    {
      id: 1,
      subject: "Matem√°ticas",
      title: "Ejercicios de √°lgebra",
      description: "Resolver ejercicios de las p√°ginas 45-47",
      dueDate: "2024-10-15",
      status: "Pendiente",
      priority: "Alta",
      icon: "üìê",
      color: "#FF6347",
      instructions: "Resuelve todos los ejercicios mostrando el procedimiento completo. Recuerda verificar tus respuestas y escribir de forma legible.",
      materials: [
        { name: "guia_algebra.pdf", type: "Archivo del profesor" },
        { name: "ejemplos_resueltos.pdf", type: "Archivo del profesor" },
      ],
    },
    {
      id: 2,
      subject: "Espa√±ol y Literatura",
      title: "Lectura y resumen",
      description: "Leer cap√≠tulo 3 y hacer resumen de 1 p√°gina",
      dueDate: "2024-10-16",
      status: "En proceso",
      priority: "Media",
      icon: "üìö",
      color: "#8A2BE2",
      instructions: "El resumen debe incluir ideas principales y conclusiones personales.",
      materials: [
        { name: "capitulo_3.pdf", type: "Archivo del profesor" },
      ],
    },
    {
      id: 3,
      subject: "Ciencias Naturales",
      title: "Consulta del Sistema Solar",
      description: "Presentaci√≥n con im√°genes y datos",
      dueDate: "2024-10-18",
      status: "Pendiente",
      priority: "Media",
      icon: "üî¨",
      color: "#1E90FF",
      instructions: "Incluir m√≠nimo 5 planetas, sus caracter√≠sticas y una imagen por planeta.",
      materials: [
        { name: "sistema_solar_guia.pdf", type: "Archivo del profesor" },
      ],
    },
    {
      id: 4,
      subject: "Ingl√©s",
      title: "Vocabulary Unit 5",
      description: "Complete exercises 1-10",
      dueDate: "2024-10-14",
      status: "Completado",
      priority: "Baja",
      icon: "üåç",
      color: "#32CD32",
      instructions: "Escribe las palabras en contexto y define cada una.",
      materials: [], 
    },
  ];

  const handleViewTaskDetails = (task) => {
    setSelectedTask(task);
    setIsModalOpen(true);
  };

  const closeModal = () => {
    setIsModalOpen(false);
    setSelectedTask(null);
    setUploadedFiles([]);
    setComment("");
  };

  const handleKeyDown = (e) => {
    if (e.key === "Escape") closeModal();
  };

  const handleFileChange = (e) => {
    const files = Array.from(e.target.files);
    setUploadedFiles((prev) => [...prev, ...files]);
  };

  const handleDragOver = (e) => {
    e.preventDefault();
  };

  const handleDrop = (e) => {
    e.preventDefault();
    const files = Array.from(e.dataTransfer.files);
    setUploadedFiles((prev) => [...prev, ...files]);
  };

  const handleSubmit = () => {
    alert("Tarea enviada con √©xito!");
    closeModal();
  };

  return (
    <div className="taskDo-container" onKeyDown={handleKeyDown} tabIndex={0}>
      <NavbarModulo />
      <div className="page-container">
        <button onClick={handleBack} className="back-button">
          <span className="back-icon">‚Üê</span>
          Volver al inicio
        </button>
      </div>
      <div className="page-title">
        <h4>Mis Tareas</h4>
        <p className="taskDo-subtitle">
          Gestiona y completa tus actividades acad√©micas
        </p>
      </div>
      <div className="tasks-grid">
        {homework.map((task) => (
          <TaskStudent
            key={task.id}
            task={task}
            onViewDetails={handleViewTaskDetails}
            variant="default"
            gradientStart={`${task.color} -30)}`}
          />
        ))}
      </div>

      {/* Modal Estudiante */}
      {isModalOpen && selectedTask && (
        <div className="modal-overlay-student" onClick={closeModal}>
          <div
            className="modal-content-student"
            onClick={(e) => e.stopPropagation()}
          >
            <button className="modal-close-btn-student" onClick={closeModal}>
              <X size={20} />
            </button>

            <div className="modal-title-stem">
              <span className="title-colegio">Colegio</span>
              <span className="title-stem">STEM 360</span>
            </div>

            <div className="modal-header-student">
              <span className="modal-icon-student">{selectedTask.icon}</span>
              <div className="modal-header-student-title">
                <span className="subject-tag">{selectedTask.subject}</span>
                <h2>{selectedTask.title}</h2>
              </div>
            </div>

            <div className="modal-body-student">
              <div className="due-date-section">
                <Calendar size={16} color="#2563eb" />
                <span>
                  Fecha de entrega:{" "}
                  {new Date(selectedTask.dueDate).toLocaleDateString("es-ES")}
                </span>
              </div>

              <div className="section-box description-box">
                <div className="section-header">
                  <FileText size={16} color="#2563eb" />
                  <strong>Descripci√≥n</strong>
                </div>
                <p>{selectedTask.description}</p>
              </div>

              <div className="section-box instructions-box">
                <div className="section-header">
                  <FileText size={16} color="#2563eb" />
                  <strong>Instrucciones</strong>
                </div>
                <p>{selectedTask.instructions}</p>
              </div>

              <div className="section-box materials-box">
                <div className="section-header">
                  <FileText size={16} color="#2563eb" />
                  <strong>Material del Profesor</strong>
                </div>
                {Array.isArray(selectedTask.materials) && selectedTask.materials.length > 0 ? (
                  selectedTask.materials.map((material, index) => (
                    <div key={index} className="material-item">
                      <div className="material-info">
                        <div className="material-icon">
                          <FileText size={20} color="#16a34a" />
                        </div>
                        <div>
                          <div className="material-name">{material.name}</div>
                          <div className="material-type">{material.type}</div>
                        </div>
                      </div>
                      <button className="download-btn">
                        <Download size={16} /> Descargar
                      </button>
                    </div>
                  ))
                ) : (
                  <p className="no-materials">No hay material disponible para esta tarea.</p>
                )}
              </div>

              <div className="section-box upload-box">
                <div className="section-header">
                  <UploadCloud size={16} color="#2563eb" />
                  <strong>Sube tu Trabajo</strong>
                </div>
                <div
                  className="upload-area"
                  onDragOver={handleDragOver}
                  onDrop={handleDrop}
                  onClick={() => document.getElementById("fileInput").click()}
                >
                  <UploadCloud size={40} color="#2563eb" />
                  <p>Arrastra archivos aqu√≠ o haz clic para seleccionar</p>
                  <p className="upload-hint">PDF, Word, PowerPoint, Im√°genes (M√°x. 10MB)</p>
                </div>
                <input
                  id="fileInput"
                  type="file"
                  multiple
                  onChange={handleFileChange}
                  style={{ display: "none" }}
                />
                {Array.isArray(uploadedFiles) && uploadedFiles.length > 0 && (
                  <div className="uploaded-files-list">
                    {uploadedFiles.map((file, index) => (
                      <div key={index} className="uploaded-file">
                        {file.name} ({(file.size / 1024 / 1024).toFixed(2)} MB)
                      </div>
                    ))}
                  </div>
                )}
              </div>

              <div className="section-box comments-box">
                <div className="section-header">
                  <MessageSquare size={16} color="#2563eb" />
                  <strong>Comentarios adicionales</strong>
                </div>
                <textarea
                  className="comment-input"
                  placeholder="Escribe aqu√≠ cualquier comentario o pregunta para tu profesor..."
                  value={comment}
                  onChange={(e) => setComment(e.target.value)}
                  rows={4}
                />
              </div>
            </div>

            <div className="modal-footer-student">
              <button className="btn-secondary-student" onClick={closeModal}>
                Cerrar
              </button>
              <button className="btn-primary-student" onClick={handleSubmit}>
                Enviar Tarea
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default Tareashacer;